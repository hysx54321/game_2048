{% extends "base_generic.html" %}
{% block title %}<title>2048</title>{% endblock %}
{% block additional_css %}
<link rel="stylesheet" href="{% static 'css/game.css' %}">
{% endblock %}

{% block icon %}
  <link rel="apple-touch-icon" type="image/png"
    href="https://static.codepen.io/assets/favicon/apple-touch-icon-5ae1a0698dcc2402e9712f7d01ed509a57814f994c660df9f7a952f3060705ee.png" />
  <meta name="apple-mobile-web-app-title" content="CodePen">
  <link rel="shortcut icon" type="image/x-icon"
    href="https://static.codepen.io/assets/favicon/favicon-aec34940fbc1a6e787974dcd360f2c6b63348d4b1f4e06c77743096d55480f33.ico" />
  <link rel="mask-icon" type=""
    href="https://static.codepen.io/assets/favicon/logo-pin-8f3771b1072e3c38bd662872f6b673a722f4b3ca2421637d5596661b4e2132cc.svg"
    color="#111" />
{% endblock %}

{% block head_script %}
  <script>
    window.console = window.console || function (t) { };
  </script>
  <script>
    if (document.location.search.match(/type=embed/gi)) {
      window.parent.postMessage("resize", "*");
    }
  </script>
{% endblock %}

{% block content %}

<div id="errors" style="
  background: #c00;
  color: #fff;
  display: none;
  margin: -20px -20px 20px;
  padding: 20px;
  white-space: pre-wrap;
"></div>
  <div id="root"></div>
  <script>
    window.addEventListener('mousedown', function (e) {
      document.body.classList.add('mouse-navigation');
      document.body.classList.remove('kbd-navigation');
    });
    window.addEventListener('keydown', function (e) {
      if (e.keyCode === 9) {
        document.body.classList.add('kbd-navigation');
        document.body.classList.remove('mouse-navigation');
      }
    });
    window.addEventListener('click', function (e) {
      if (e.target.tagName === 'A' && e.target.getAttribute('href') === '#') {
        e.preventDefault();
      }
    });
    window.onerror = function (message, source, line, col, error) {
      var text = error ? error.stack || error : message + ' (at ' + source + ':' + line + ':' + col + ')';
      errors.textContent += text + '\n';
      errors.style.display = '';
    };
    console.error = (function (old) {
      return function error() {
        errors.textContent += Array.prototype.slice.call(arguments).join(' ') + '\n';
        errors.style.display = '';
        old.apply(this, arguments);
      }
    })(console.error);
  </script>

  <script src='https://unpkg.com/react@16/umd/react.development.js'></script>
  <script src='https://unpkg.com/react-dom@16/umd/react-dom.development.js'></script>
  <script id="rendered-js">
    function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
          var cookie = cookies[i].trim();
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function httpPost(URL, PARAMS) {
      var form = document.createElement("form");
      form.action = URL;
      form.method = "POST";
      form.style.display = "none";
      for (var key in PARAMS) {
        var field = document.createElement("textarea");
        field.name = key;
        field.value = PARAMS[key];
        form.appendChild(field);
      }
      document.body.appendChild(form);
      form.submit();
      return form;
    }

    class Board extends React.Component {
      constructor(props) {
        super(props);
        this.size = props.size;
      }

      renderRow(i) {
        var r = [];
        // var r = ["div", { className: "board-row" }];
        for (let j = 0; j < this.size; j++) {
          // console.log(i * this.size + j);
          r.push(React.createElement("button", { className: "square", key: i + ',' + j },
          this.props.board[i][j] == 0 ? "" : this.props.board[i][j]));
        }

        // console.log('row' + i);
        return React.createElement("div", { className: "board-row", key: 'row' + i }, r);
        // return React.createElement(r);
      }

      render() {
        var board = [];
        for (let j = 0; j < this.size; j++) {
          board.push(this.renderRow(j));
        }
        return React.createElement("div", null, board);
      }
    }

    function emptyMatrix(numRow, numCol) {
      var arr = [];
      for (var i = 0; i < numRow; ++i) {
        var columns = [];
        for (var j = 0; j < numCol; ++j) {
          columns[j] = 0;
        }
        arr[i] = columns;
      }
      return arr;
    }

    function cloneMatrix(matrix) {
      var newMatrix = [];
      for (var i = 0; i < matrix.length; ++i) {
        var columns = [];
        for (var j = 0; j < matrix[0].length; ++j) {
          columns[j] = matrix[i][j];
        }
        newMatrix[i] = columns;
      }
      return newMatrix;
    }

    function copyMatrix(matrix, target) {
      for (var i = 0; i < target.length; ++i) {
        for (var j = 0; j < target[0].length; ++j) {
          matrix[i][j] = target[i][j];
        }
      }
    }

    function rotateClockwise(matrix) {
      var newMatrix = emptyMatrix(matrix[0].length, matrix.length);
      for (let i = 0; i < matrix.length; i++) {
        for (let j = 0; j < matrix[0].length; j++) {
          newMatrix[j][matrix[0].length - 1 - i] = matrix[i][j];
        }
      }
      copyMatrix(matrix, newMatrix);
      // matrix = newMatrix;
      // return newMatrix;
    }

    function rotateAntiClockwise(matrix) {
      var newMatrix = emptyMatrix(matrix[0].length, matrix.length);
      for (let i = 0; i < matrix.length; i++) {
        for (let j = 0; j < matrix[0].length; j++) {
          newMatrix[matrix.length - 1 - j][i] = matrix[i][j];
        }
      }
      copyMatrix(matrix, newMatrix);
      // matrix = newMatrix;
      // return newMatrix;
    }

    function reflect(matrix) {
      var newMatrix = emptyMatrix(matrix.length, matrix[0].length);
      for (let i = 0; i < matrix.length; i++) {
        for (let j = 0; j < matrix[0].length; j++) {
          newMatrix[i][matrix[0].length - 1 - j] = matrix[i][j];
        }
      }
      copyMatrix(matrix, newMatrix);
      // matrix = newMatrix;
      // return newMatrix;
    }

    function merge(matrix) {
      var score = 0;
      var move = 0;
      move += moveToLeft(matrix);
      for (let i = 0; i < matrix.length; i++) {
        for (let j = 1; j < matrix[0].length; j++) {
          if (matrix[i][j - 1] == matrix[i][j]) {
            score += matrix[i][j];
            matrix[i][j - 1] *= 2;
            matrix[i][j] = 0;
          }
        }
      }
      move += moveToLeft(matrix);
      return { score: score, move: move };
    }

    function moveToLeft(matrix) {
      var move = 0;
      for (let i = 0; i < matrix.length; i++) {
        var index = 0;
        for (let j = 0; j < matrix[0].length; j++) {
          if (matrix[i][j] != 0) {
            if (j == index) {
              index++;
              continue;
            }
            move++;
            matrix[i][index++] = matrix[i][j];
            matrix[i][j] = 0;
          }
        }
      }
      return move;
    }

    var test = [
      [2, 4, 4, 8],
      [4, 16, 32, 4],
      [2, 16, 128, 4],
      [4, 2, 2, 4]
    ];

    var test = [
      [16, 8, 4, 2],
      [64, 32, 16, 4],
      [128, 64, 32, 8],
      [2, 32, 16, 2]
    ];

    function up(matrix) {
      rotateAntiClockwise(matrix);
      var result = merge(matrix);
      rotateClockwise(matrix);
      return result;
    }

    function down(matrix) {
      rotateClockwise(matrix);
      var result = merge(matrix);
      rotateAntiClockwise(matrix);
      return result;
    }

    function left(matrix) {
      var result = merge(matrix);
      return result;
    }

    function right(matrix) {
      reflect(matrix);
      var result = merge(matrix);
      reflect(matrix);
      return result;
    }

    function isEndGame(matrix) {
      for (let i = 0; i < matrix.length; i++) {
        for (let j = 0; j < matrix[0].length; j++) {
          if (matrix[i][j] == 0) return false;
          if (i != 0 && matrix[i - 1][j] == matrix[i][j]) return false;
          if (i != matrix.length - 1 && matrix[i + 1][j] == matrix[i][j]) return false;
          if (j != 0 && matrix[i][j - 1] == matrix[i][j]) return false;
          if (j != matrix[0].length - 1 && matrix[i][j + 1] == matrix[i][j]) return false;
        }
      }
      console.log(matrix);
      console.log("Game ends");
      return true;
    }

    function addRandom(matrix) {
      var random = Math.floor((Math.random() * 10) + 1);
      var number = random == 1 ? 4 : 2;
      do {
        var row = Math.floor((Math.random() * matrix.length));
        var col = Math.floor((Math.random() * matrix.length));
      }
      while (matrix[row][col] != 0);
      matrix[row][col] = number;
    }

    class Game extends React.Component {
      constructor(props) {
        super(props);
        this.size = 4;
        this.state = {
          gameStarted: false,
          board: emptyMatrix(this.size, this.size),
          message: "Click 'Start' to start the game"
        };
        this.handleKeyDown = this.handleKeyDown.bind(this);
        this.startGame = this.startGame.bind(this);
        this.endGame = this.endGame.bind(this);
        this.saveGame = this.saveGame.bind(this);
        this.updateTime = this.updateTime.bind(this);
        this.undo = this.undo.bind(this);
        this.direction = {
          Up: 1,
          Down: 2,
          Left: 3,
          Right: 4
        };
      }

      startGame() {
        var board = emptyMatrix(this.size, this.size);
        addRandom(board);
        this.timer = setInterval(this.updateTime, 1000);
        this.setState({
          history: [
            {
              board: board,
              score: 0,
              previousMove: null
            }],
          board: board,
          gameStarted: true,
          gameEnds: false,
          score: 0,
          move: 0,
          uselessMove: 0,
          message: "The game has started. Good luck!",
          second: 0
        });
      }

      endGame() {
        this.setState({
          gameEnds: true,
          message: "The game has been terminated.",
        })
        this.saveGame();
      }

      updateTime() {
        if (this.state.gameEnds) {
          clearInterval(this.timer);
          return;
        }
        this.setState({
          second: this.state.second + 1
        })
      }

      saveGame() {
        console.log("This is the end of the game");
        console.log(this.state);
        var history = JSON.stringify(this.state.history);
        console.log(history);
        // var obj = JSON.parse(history);
        // console.log(obj);
        var csrftoken = getCookie('csrftoken');
        console.log(csrftoken);
        httpPost(
          "../save_game/",
          {
            second: this.state.second,
            score: this.state.score,
            move: this.state.move,
            reconstruction: history,
            csrfmiddlewaretoken: csrftoken
          }
        );
      }

      undo() {
        var history = this.state.history;
        if (history.length == 1) return;
        history.pop();
        var current = history[history.length - 1];
        this.setState({
          history: history,
          board: current.board,
          score: current.score,
          move: history.length - 1
        })
      }

      handleKeyDown(e) {
        if (this.state.gameStarted && this.state.gameEnds) return;
        var key = e.key;
        console.log(e.key);
        var board = cloneMatrix(this.state.board);
        var result;
        var move;
        switch (key) {
          case "ArrowUp":
            move = this.direction.Up;
            result = up(board);
            // code for "down arrow" key press.
            break;
          case "ArrowDown":
            move = this.direction.Down;
            result = down(board);
            // code for "up arrow" key press.
            break;
          case "ArrowLeft":
            move = this.direction.Left;
            result = left(board);
            // code for "left arrow" key press.
            break;
          case "ArrowRight":
            move = this.direction.Right;
            result = right(board);
            // code for "right arrow" key press.
            break;
          default:
            return; // Quit when this doesn't handle the key event.
        }

        if (result.score == 0 && result.move == 0) {
          this.setState({
            uselessMove: this.state.uselessMove + 1
          });
          return;
        }

        addRandom(board);

        let gameEnd = isEndGame(board);
        var message;
        if (gameEnd) {
          message = "Game ends";
        } else {
          message = "Keep playing";
        }

        var history = this.state.history;
        var score = this.state.score + result.score;
        history.push({
          board: board,
          score: score,
          previousMove: move
        });

        this.setState({
          history: history,
          board: board,
          gameEnds: gameEnd,
          score: score,
          message: message,
          move: this.state.move + 1
        });

        if (gameEnd) this.saveGame();
      }

      render() {
        var board = this.state.board;
        var message = this.state.message;
        var scoreBoard = this.state.gameStarted ? React.createElement("ol", null, "Score:" + this.state.score) : null;
        var moveBoard = this.state.gameStarted ? React.createElement("ol", null, "Move:" + this.state.move) : null;
        var uselessMoveBoard = this.state.gameStarted ? React.createElement("ol", null, "Useless move:" + this.state.uselessMove) : null;
        var timer = this.state.gameStarted ? React.createElement("ol", null, "Second:" + this.state.second) : null;
        var startButton = this.state.gameEnds || !this.state.gameStarted ? React.createElement("button", { className: "start", onClick: this.startGame }, "Start") : "";
        var endButton = this.state.gameStarted && !this.state.gameEnds ? React.createElement("button", { className: "end", onClick: this.endGame }, "End Game") : "";
        var undoButton = this.state.gameStarted && !this.state.gameEnds ? React.createElement("button", { className: "undo", onClick: this.undo }, "Undo") : "";

        //var saveGameForm = this.state.gameEnds ? React.createElement("form", { className: "save", onClick: this.startGame }, "Start") : "";
        return (
          React.createElement("div", { className: "game", onKeyDown: this.handleKeyDown, tabIndex: "888", key: 'game' },
            React.createElement("div", { className: "game-board", key: 'board' },
              React.createElement(Board, {
                board: board,
                size: this.size
              })),
            React.createElement("div", { className: "game-info", key: 'info' },
              React.createElement("div", { className: "message", key: 'message' }, message),
              scoreBoard,
              moveBoard,
              uselessMoveBoard,
            ),
            timer,
            startButton,
            endButton,
            undoButton
          ));
      }
    }
    // ========================================

    ReactDOM.render(React.createElement(Game, null), document.getElementById("root"));
//# sourceURL=pen.js
  </script>

{% endblock %}